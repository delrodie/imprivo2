{% extends 'base.html.twig' %}
{% block extra_title %}Les d√©tails du d√©vis {{ devis ? devis.numero : 'Inconnu' }}{% endblock %}

{% block body %}
    <main class="main-content" data-sidebar-target="mainContent">
        <div class="container-fluid">
            <!-- Section Performance -->
            <div class="card facture p-4 mb-4 mt-5">
                <div
                    class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
                    <div>
                        {% set statut = devis.statut.value %}
                        <h2 class="h3 fw-bold mb-1">Le d√©vis {{ devis? devis.numero : "" }}</h2>
                        {% if statut == 'ENVOYE' or statut == 'ACCEPTE' or statut == 'REJETE' or statut == 'TRANSFORME' %}
                            <details>
                                <summary class="text-muted small">Details</summary>
                                <p class="text-muted small">Cr√©e par {{ devis ? devis.createdBy }} le {{ devis ? devis.createdAt|date('Y-m-d H:i:s') }}</p>
                                {% if statut == 'ENVOYE' %}
                                    <p class="text-muted small">Envoy√© par {{ devis ? devis.sendedBy }} le {{ devis ? devis.sendedAt|date('Y-m-d H:i:s') }}</p>
                                {% endif %}
                            </details>
                        {% endif %}

                    </div>
                    <a href="#" class="btn btn-chart btn-sm"><i class="bi bi-filetype-pdf"></i> Exporter</a>
                </div>
                <div class="position-relative" style="min-height: 300px;">
                    <div class="row mt-5">
                        <div class="col-md-6 offset-md-6 mt-3">Date: <span>{{ devis ? devis.date|date('Y-dm-d') : '' }}</span> </div>
                        <div class="col-md-6 offset-md-6 mt-2">Numero: <span>{{ devis ? devis.numero : '' }}</span></div>
                        <div class="col-md-12 mt-3">
                            <div>Client: <span>{{ devis ? devis.client.nom :  '' }}</span></div>
                            <div>Adresse: <span>{{ devis ? devis.client.adresse : '' }}</span></div>
                            <div>T√©lephone: <span>{{ devis ? devis.client.telephone : '' }}</span></div>
                            <div class="mt-2">Repesentant :  <span>{{ devis ? devis.contactClient.nom }} {{ devis ? devis.contactClient.prenom }}</span></div>
                            <div>Email: <span>{{ devis ? devis.contactClient.email }}</span></div>
                            <div>T√©l√©phone: <span>{{ devis ? devis.contactClient.telephone1 }} {{ devis ? devis.contactClient.telephone2 ? '/' ~ devis.contactClient.telephone2 : '' }}</span></div>
                        </div>
                        <div class="col-md-12 mt-4">
                            <table class="table table-striped table-hover table-sm table-responsive caption-top w-100">
                                <caption>Lignes du devis</caption>
                                <thead>
                                <tr>
                                    <th class="text-center">ID</th>
                                    <th class="text-center">D√©signation</th>
                                    <th class="text-center">P.Unitaire</th>
                                    <th class="text-center">Quantit√©</th>
                                    <th class="text-center">UOM</th>
                                    <th class="text-center">Montant</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for ligne in devis.lignes  %}
                                    <tr>
                                        <td class="text-center">{{ loop.index }}</td>
                                        <td>{{ ligne.designation }}</td>
                                        <td class="text-end pe-2">{{ ligne.prixUnitaire|number_format(0, ' ', ' ') }}</td>
                                        <td class="text-center">{{ ligne.quantite }}</td>
                                        <td class="text-center">{{ ligne.uom.libelle }}</td>
                                        <td class="text-end pe-2">{{ ligne.montant|number_format('0', ' ', ' ') }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr><td class="mt-5 no-bordered"></td></tr>
                                    <tr>
                                        <td colspan="5" class="text-end pe-3 no-bordered">Total HT</td>
                                        <th class="text-end pe-2">{{ devis ? devis.totalHT|number_format(0, ' ', ' ') }}</th>
                                    </tr>
                                    {% if devis ? devis.remise %}
                                        <tr>
                                            <td colspan="5" class="text-end pe-3 no-bordered">Remise</td>
                                            <th class="text-end pe-2">{{ devis ? devis.remise|number_format(0, ' ', ' ') }}</th>
                                        </tr>
                                    {% endif %}
                                    {% if devis ? devis.tauxTVA %}
                                        <tr>
                                            <td colspan="5" class="text-end pe-3 no-bordered">TVA ({{ devis ? devis.tauxTVA }}%)</td>
                                            <th class="text-end pe-2">{{ devis ? devis.totalTVA|number_format(0, ' ', ' ') }}</th>
                                        </tr>
                                    {% endif %}
                                    <tr>
                                        <td colspan="5" class="text-end pe-3 no-bordered">Total TTC</td>
                                        <th class="text-end pe-2 fs-5 table-active">{{ devis ? devis.totalTTC|number_format(0, ' ', ' ') }}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {% if devis ? devis.noteInterne %}
                            <div class="col-md-6 mt-5">
                                <div>Note interne:</div>
                                <div>{{ devis ? devis.noteInterne|raw }}</div>
                            </div>
                        {% endif %}
                        {% if devis ? devis.noteClient %}
                            <div class="col-md-6 mt-5">
                                <div>Note client:</div>
                                <div>{{ devis ? devis.noteClient|raw }}</div>
                            </div>
                        {% endif %}
                    </div>
                    <div class="row mt-5 mb-3">

                        <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>

                        <form
                            action="{{ path('app_devistransfom_update') }}"
                            method="POST"
                            data-controller="notification"
                            data-action="submit->notification#submit"
                            data-redirect="{{ path('app_devis_index') }}"
                        >
                            <div class="d-flex justify-content-end">

                                <input type="hidden" name="devis_id" value="{{ devis.id }}">
                                <input type="hidden" name="_token" value="{{ csrf_token('update' ~ devis.id) }}">

                                {% if devis.statut.value == 'TRANSFORME' %}
                                    <a href="{{ path('app_devis_index') }}" class="btn btn-outline-secondary btn-sm me-3"><i class="bi bi-reply-all"></i> ANNULER</a>
                                    <a href="#" class="btn btn-chart btn-sm">Transform√© en facture</a>
                                {% elseif devis.statut.value == 'ACCEPTE' %}
                                    <a href="{{ path('app_devis_index') }}" class="btn btn-outline-secondary btn-sm me-3"><i class="bi bi-reply-all"></i> ANNULER</a>
                                    <a href="#" class="btn btn-chart btn-sm">A transformer en facture</a>
                                {% elseif devis.statut.value == 'ENVOYE' %}
                                    <a href="{{ path('app_devis_index') }}" class="btn btn-outline-secondary btn-sm me-3"><i class="bi bi-reply-all"></i> ANNULER</a>
                                    <a href="#" class="btn btn-secondary btn-sm me-3"><i class="bi bi-file-earmark-medical"></i> Brouillon</a>
                                    <button
                                        type="submit"
                                        name="devis_btn"
                                        value="rejeter"
                                        data-redirect="{{ path('app_devis_index') }}"
                                        data-message="Devis rejet√© ‚ùå"
                                        class="btn btn-danger btn-sm me-3"
                                    >
                                        <i class="bi bi-x-square"></i> REJETER
                                    </button>

                                    <button
                                        type="submit"
                                        name="devis_btn"
                                        value="accepter"
                                        data-redirect="{{ path('app_devis_index') }}"
                                        data-message="Devis accept√© üéâ"
                                        class="btn btn-success btn-sm me-3"
                                    >
                                        <i class="bi bi-check2-square"></i> ACCEPTER
                                    </button> {# data-redirect="{{ path('app_facture_index') }}" #}
                                {% else %}
                                    <a href="{{ path('app_devis_index') }}" class="btn btn-outline-secondary btn-sm me-3"><i class="bi bi-reply-all"></i> ANNULER</a>
                                    <button
                                        type="submit"
                                        name="devis_btn"
                                        value="envoyer"
                                        data-redirect="{{ path('app_devis_index') }}"
                                        data-message="Devis envoy√© avec succ√®s ‚úÖ"
                                        class="btn btn-chart btn-sm me-3"
                                    >
                                        <i class="bi bi-send"></i> ENVOYER
                                    </button>
                                {% endif %}

                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </main>
{% endblock %}




{% extends 'base.html.twig' %}
{% block extra_title %}Les détails de la facture {{ facture ? facture.numero : 'Inconnue' }}{% endblock %}

{% block body %}
    <main class="main-content" data-sidebar-target="mainContent">
        <div class="container-fluid">
            <!-- Section Performance -->
            <div class="card facture p-4 mb-4 mt-5">
                <div
                    class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
                    <div>
                        {% set statut = facture.statut.value %}
                        <h2 class="h3 fw-bold mb-1">La facture {{ facture? facture.numero : "" }}</h2>
                        {% if statut == 'ENVOYE' or statut == 'ACCEPTE' or statut == 'REJETE' or statut == 'TRANSFORME' %}
                            <details>
                                <summary class="text-muted small">Details</summary>
                                <p class="text-muted small">Créée par {{ facture ? facture.createdBy }} le {{ facture ? facture.createdAt|date('Y-m-d H:i:s') }}</p>

                            </details>
                        {% endif %}

                    </div>
                    <a href="#" class="btn btn-chart btn-sm"><i class="bi bi-filetype-pdf"></i> Exporter</a>
                </div>
                <div class="position-relative" style="min-height: 300px;">
                    <div class="row mt-5">
                        <div class="col-md-6 offset-md-6 mt-3">Date: <span>{{ facture ? facture.date|date('Y-dm-d') : '' }}</span> </div>
                        <div class="col-md-6 offset-md-6 mt-2">Numero: <span>{{ facture ? facture.numero : '' }}</span></div>
                        <div class="col-md-12 mt-3">
                            <div>Client: <span>{{ facture ? facture.client.nom :  '' }}</span></div>
                            <div>Adresse: <span>{{ facture ? facture.client.adresse : '' }}</span></div>
                            <div>Télephone: <span>{{ facture ? facture.client.telephone : '' }}</span></div>
                        </div>
                        <div class="col-md-12 mt-4">
                            <table class="table table-striped table-hover table-sm table-responsive caption-top w-100">
                                <caption>Lignes du facture</caption>
                                <thead>
                                <tr>
                                    <th class="text-center">ID</th>
                                    <th class="text-center">Désignation</th>
                                    <th class="text-center">P.Unitaire</th>
                                    <th class="text-center">Quantité</th>
                                    <th class="text-center">UOM</th>
                                    <th class="text-center">Montant</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for ligne in facture.lignes  %}
                                    <tr>
                                        <td class="text-center">{{ loop.index }}</td>
                                        <td>{{ ligne.designation }}</td>
                                        <td class="text-end pe-2">{{ ligne.prixUnitaire|number_format(0, ' ', ' ') }}</td>
                                        <td class="text-center">{{ ligne.quantite }}</td>
                                        <td class="text-center">{{ ligne.uom.libelle }}</td>
                                        <td class="text-end pe-2">{{ ligne.montant|number_format('0', ' ', ' ') }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                                <tfoot>
                                <tr><td class="mt-5 no-bordered"></td></tr>
                                <tr>
                                    <td colspan="5" class="text-end pe-3 no-bordered">Total HT</td>
                                    <th class="text-end pe-2">{{ facture ? facture.totalHT|number_format(0, ' ', ' ') }}</th>
                                </tr>
                                {% if facture ? facture.remise %}
                                    <tr>
                                        <td colspan="5" class="text-end pe-3 no-bordered">Remise</td>
                                        <th class="text-end pe-2">{{ facture ? facture.remise|number_format(0, ' ', ' ') }}</th>
                                    </tr>
                                {% endif %}
                                {% if facture ? facture.tauxTVA %}
                                    <tr>
                                        <td colspan="5" class="text-end pe-3 no-bordered">TVA ({{ facture ? facture.tauxTVA }}%)</td>
                                        <th class="text-end pe-2">{{ facture ? facture.totalTVA|number_format(0, ' ', ' ') }}</th>
                                    </tr>
                                {% endif %}
                                <tr>
                                    <td colspan="5" class="text-end pe-3 no-bordered">Total TTC</td>
                                    <th class="text-end pe-2 fs-5 table-active">{{ facture ? facture.totalTTC|number_format(0, ' ', ' ') }}</th>
                                </tr>
                                </tfoot>
                            </table>
                        </div>

                    </div>
                    <div class="row mt-5 mb-3">

                        <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>

                        <form
                            action="{{ path('app_facture_update') }}"
                            method="POST"
                            data-controller="notification"
                            data-action="submit->notification#submit"
                            data-redirect="{{ path('app_facture_index') }}"
                        >
                            <div class="d-flex justify-content-end">

                                <input type="hidden" name="facture_id" value="{{ facture.uuid }}">
                                <input type="hidden" name="_token" value="{{ csrf_token('update' ~ facture.id) }}">

                                {% if facture.statut.value == 'BROUILLON' %}
                                    <a href="{{ path('app_facture_index') }}" class="btn btn-outline-secondary btn-sm me-3"><i class="bi bi-reply-all"></i> RETOUR A LA LISTE</a>

                                    <button
                                        type="submit"
                                        name="facture_btn"
                                        value="annuler"
                                        data-redirect="{{ path('app_facture_index') }}"
                                        data-message="facture annulée ❌"
                                        class="btn btn-danger btn-sm me-3"
                                    >
                                        <i class="bi bi-x-square"></i> ANNULER
                                    </button>

                                    <button
                                        type="submit"
                                        name="facture_btn"
                                        value="valider"
                                        data-redirect="{{ path('app_facture_index') }}"
                                        data-message="facture envoyé avec succès ✅"
                                        class="btn btn-chart btn-sm me-3"
                                    >
                                        <i class="bi bi-check-square"></i> VALIDER
                                    </button>
                                {% elseif facture.statut.value == 'VALIDEE' %}
                                    <a href="{{ path('app_facture_index') }}" class="btn btn-outline-secondary btn-sm me-3 px-3"><i class="bi bi-reply-all"></i> RETOUR A LA LISTE</a>
                                    <button
                                        type="submit"
                                        name="facture_btn"
                                        value="regler"
                                        data-redirect="{{ path('app_facture_index') }}"
                                        data-message="facture transformé en facture avec succès!"
                                        class="btn btn-chart btn-sm px-5"
                                    >
                                        <i class="bi bi-file-earmark-medical"></i> REGLER
                                    </button>


                                {% else %}
                                    <a href="{{ path('app_facture_index') }}" class="btn btn-outline-secondary btn-sm me-3"><i class="bi bi-reply-all"></i> RETOUR A LA LISTE</a>

                                {% endif %}

                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </main>
{% endblock %}



